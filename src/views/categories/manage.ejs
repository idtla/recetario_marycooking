<%- include('../partials/header') %>

<div class="container px-6 mx-auto">
    <div class="my-6">
        <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-200">
            Gestión de Categorías
        </h2>
        
        <!-- Botón para crear nueva categoría -->
        <div class="mt-4">
            <button onclick="openNewCategoryModal()"
                    class="px-4 py-2 text-sm font-medium leading-5 text-white transition-colors duration-150 bg-purple-600 border border-transparent rounded-lg active:bg-purple-600 hover:bg-purple-700 focus:outline-none focus:shadow-outline-purple">
                + Nueva Categoría
            </button>
        </div>

        <!-- Lista de categorías -->
        <div class="mt-6">
            <div class="mt-1 p-3 bg-white dark:bg-gray-700 rounded-md border dark:border-gray-600">
                <% 
                function findChildren(categories, parentId) {
                    return categories.filter(cat => cat.parentId === parentId);
                }

                function renderCategory(category, level = 0) { %>
                    <div class="<%= level > 0 ? 'ml-6 mt-2' : 'mt-2' %> relative">
                        <% if (level > 0) { %>
                            <div class="absolute left-0 top-0 h-full w-px bg-gray-300 dark:bg-gray-600" 
                                 style="transform: translateX(-1rem)"></div>
                            <div class="absolute left-0 top-1/2 w-4 h-px bg-gray-300 dark:bg-gray-600"
                                 style="transform: translateX(-1rem)"></div>
                        <% } %>
                        
                        <div class="flex items-center justify-between py-2 border-b border-gray-200 dark:border-gray-600">
                            <div class="flex items-center">
                                <%= category.name %>
                            </div>
                            <div class="flex items-center space-x-4">
                                <button onclick="openEditCategoryModal(`<%= category.id %>`, `<%= category.name %>`, `<%= category.parentId || '' %>`)"
                                        class="text-purple-600 hover:text-purple-900 dark:text-purple-400 dark:hover:text-purple-300">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                                    </svg>
                                </button>
                                <button onclick="deleteCategory(`<%= category.id %>`)"
                                        class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                <%
                    const children = findChildren(categories, category.id);
                    children.forEach(child => {
                        renderCategory(child, level + 1);
                    });
                }

                // Renderizar categorías principales
                const mainCategories = categories.filter(cat => !cat.parentId);
                mainCategories.forEach(category => {
                    renderCategory(category);
                });
                %>
            </div>
        </div>
    </div>
</div>

<!-- Modal Categoría -->
<dialog id="categoryModal" class="p-0 max-w-md rounded-lg shadow-lg">
    <div class="p-6">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-5">
            Nueva Categoría
        </h3>
        
        <form id="categoryForm" method="POST">
            <input type="hidden" id="categoryId" name="categoryId">
            <div class="mb-4">
                <label class="block text-sm">
                    <span class="text-gray-700 dark:text-gray-400">Nombre</span>
                    <input type="text" 
                           name="name" 
                           id="categoryName"
                           required
                           class="block w-full mt-1 text-sm dark:border-gray-600 dark:bg-gray-700 focus:border-purple-400 focus:outline-none focus:shadow-outline-purple dark:text-gray-300 dark:focus:shadow-outline-gray form-input">
                </label>
            </div>

            <div class="mb-4">
                <label class="block text-sm">
                    <span class="text-gray-700 dark:text-gray-400">Categoría padre (opcional)</span>
                    <select name="parentId" 
                            id="categoryParent"
                            class="block w-full mt-1 text-sm dark:border-gray-600 dark:bg-gray-700 focus:border-purple-400 focus:outline-none focus:shadow-outline-purple dark:text-gray-300 dark:focus:shadow-outline-gray form-select">
                        <option value="">Ninguna (Categoría principal)</option>
                        <% categories.forEach(function(category) { %>
                            <option value="<%= category.id %>"><%= category.name %></option>
                        <% }); %>
                    </select>
                </label>
            </div>

            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" onclick="closeModal()"
                    class="px-4 py-2 text-sm font-medium leading-5 text-gray-700 transition-colors duration-150 border border-gray-300 rounded-lg dark:text-gray-400 active:bg-transparent hover:border-gray-500 focus:border-gray-500 active:text-gray-500 focus:outline-none focus:shadow-outline-gray">
                    Cancelar
                </button>
                <button type="submit"
                    class="px-4 py-2 text-sm font-medium leading-5 text-white transition-colors duration-150 bg-purple-600 border border-transparent rounded-lg active:bg-purple-600 hover:bg-purple-700 focus:outline-none focus:shadow-outline-purple">
                    Guardar
                </button>
            </div>
        </form>
    </div>
</dialog>

<script>
    const modal = document.getElementById('categoryModal');
    const form = document.getElementById('categoryForm');

    function openNewCategoryModal() {
        form.reset();
        form.action = '/categories/create';
        document.getElementById('categoryId').value = '';
        modal.showModal();
    }

    function openEditCategoryModal(id, name, parentId) {
        form.reset();
        const categoryId = document.getElementById('categoryId');
        categoryId.value = id;
        document.getElementById('categoryName').value = name;
        document.getElementById('categoryParent').value = parentId || '';
        modal.showModal();
    }

    function closeModal() {
        modal.close();
    }

    function deleteCategory(id) {
        if (confirm('¿Estás seguro de que deseas eliminar esta categoría?')) {
            window.location.href = `/categories/delete/${id}`;
        }
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        try {
            const formData = new FormData(form);
            const categoryId = formData.get('categoryId');
            const url = categoryId 
                ? `/categories/update/${categoryId}`
                : '/categories/create';

            const data = {
                name: formData.get('name'),
                parentId: formData.get('parentId') || null
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const error = await response.json();
                    throw new Error(error.message || 'Error en la operación');
                } else {
                    throw new Error('Error en el servidor');
                }
            }

            window.location.reload();
        } catch (error) {
            console.error('Error:', error);
            alert('Error al procesar la operación: ' + error.message);
        }
    });
</script>

<%- include('../partials/footer') %> 